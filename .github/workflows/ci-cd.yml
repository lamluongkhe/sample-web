name: CI/CD Pipeline - Web HAProxy Flask MySQL

on:
  push:
    branches:
      - main             # ğŸ”¹ Trigger khi push vÃ o nhÃ¡nh main
    paths:
      - 'web/**'         # ğŸ”¹ Náº¿u thay Ä‘á»•i code Flask
      - 'haproxy/**'     # ğŸ”¹ Náº¿u thay Ä‘á»•i cáº¥u hÃ¬nh HAProxy
      - 'helm/**'        # ğŸ”¹ Náº¿u thay Ä‘á»•i file Helm

jobs:
  build:
    runs-on: self-hosted   # ğŸ”¹ Cháº¡y trÃªn runner local cÃ³ Docker, Helm, Minikube, Kubectl

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push Docker image
        id: docker_build
        run: |
          IMAGE_NAME=lamluongkhe/web
          IMAGE_TAG=$(date +%Y%m%d%H%M%S)

          echo "ğŸ› ï¸ Building image $IMAGE_NAME:$IMAGE_TAG ..."
          docker build -t $IMAGE_NAME:$IMAGE_TAG ./web
          docker push $IMAGE_NAME:$IMAGE_TAG

          # LÆ°u thÃ´ng tin image Ä‘á»ƒ truyá»n sang job deploy
          echo "IMAGE_NAME=$IMAGE_NAME" > image-info.env
          echo "IMAGE_TAG=$IMAGE_TAG" >> image-info.env
          cat image-info.env

      - name: Upload image info artifact
        uses: actions/upload-artifact@v4
        with:
          name: image-info
          path: image-info.env

  deploy:
    runs-on: self-hosted
    needs: build

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Download image info
        uses: actions/download-artifact@v4
        with:
          name: image-info
          path: .

      - name: Deploy to Minikube using Helm
        run: |
          source image-info.env

          echo "ğŸš€ Deploying $IMAGE_NAME:$IMAGE_TAG to Minikube..."
          kubectl config use-context minikube
          kubectl get nodes

          helm upgrade --install web-haproxy ./helm \
            --set image.repository=$IMAGE_NAME \
            --set image.tag=$IMAGE_TAG \
            --namespace default --create-namespace

          echo "âœ… Deployment completed."

      - name: Verify Deployment
        run: |
          echo "ğŸ” Checking image in Deployment..."
          kubectl get deploy flask-web -o jsonpath='{.spec.template.spec.containers[0].image}'
          echo ""
          echo "ğŸ” Current Pods:"
          kubectl get pods -l app=flask-web

